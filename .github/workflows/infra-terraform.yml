name: Terraform

on:
  push:
    branches:
      - main
      - feat*
  workflow_dispatch:
  
env:
    AWS_REGION: us-east-1
    ECR_REPO_NAME: ${{ vars.ECR_REPO_NAME }}
    AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}

jobs:
  apply-infra:
    name: Apply Infra (VPC, ECR, EKS)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v2
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        role-to-assume: ${{ secrets.TF_ASSUME_ROLE }}
        aws-region: us-east-1

    - name: Terraform Init
      working-directory: terraform
      run: terraform init

    - name: Terraform Apply (Infra Modules)
      working-directory: terraform
      run: |
        terraform apply -auto-approve -target=module.vpc
        terraform apply -auto-approve -target=module.ecr
        terraform apply -auto-approve -target=module.eks

  apply-helm:
    name: Apply Helm
    runs-on: ubuntu-latest
    needs: apply-infra

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v2

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        role-to-assume: ${{ secrets.TF_ASSUME_ROLE }}
        aws-region: us-east-1

    - name: Terraform Init
      working-directory: terraform
      run: terraform init

    - name: Terraform Apply (Helm)
      working-directory: terraform
      run: |
        terraform apply -auto-approve -target=module.helm
